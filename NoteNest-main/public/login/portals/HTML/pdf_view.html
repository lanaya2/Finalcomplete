<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NoteNest â€“ Study Materials</title>

  <link rel="stylesheet" href="../../../main/styles.css">

  <style>
    .materials-box {
      margin-top: 12px;
    }
    .materials-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .materials-list {
      list-style:none;
      padding:0;
      margin:0;
    }
    .materials-item {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 0;
      border-bottom:1px solid #e5e7eb;
      gap:8px;
      flex-wrap:wrap;
    }
    .materials-item span {
      flex:1;
      min-width:150px;
      word-break:break-word;
    }
    .materials-actions {
      display:flex;
      gap:6px;
      flex-shrink:0;
    }
    .status-text {
      margin-top:8px;
      font-size:0.9rem;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="section">
      <h1 class="center" style="color:#4f46e5;">ðŸ“˜ NoteNest</h1>
      <h2>Study Materials</h2>
      <p class="muted">View and download shared PDF study materials.</p>

      <div class="box materials-box">
        <div class="materials-header">
          <span class="muted">Available PDFs</span>
          <a href="upload.html" class="btn" style="padding:6px 10px;font-size:.9rem;">Upload New</a>
        </div>

        <div id="materialsMessage" class="status-text muted">Loading materialsâ€¦</div>
        <ul id="materialsList" class="materials-list"></ul>
      </div>

      <p style="margin-top:12px;">
        <a href="student_homepage.html" class="btn secondary">Back to Home</a>
      </p>
    </section>
  </div>

  <!-- Optional: your existing auth guard / logout logic -->
  <script type="module" src="../../auth.js"></script>

  <script type="module">
    import { auth, db, storage } from "../../../main/firebase.js";
    import { collection, getDocs, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { ref, deleteObject } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    const materialsList    = document.getElementById("materialsList");
    const materialsMessage = document.getElementById("materialsMessage");

    let currentUser = null;
    let isTeacher   = false;

    async function loadUserRole(user) {
      try {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          const data = snap.data();
          isTeacher = data.role === "teacher";
        } else {
          isTeacher = false;
        }
      } catch (err) {
        console.error("Error loading user role:", err);
        isTeacher = false;
      }
    }

    async function loadMaterials() {
      try {
        const snap = await getDocs(collection(db, "materials"));

        if (snap.empty) {
          materialsMessage.textContent = "No study materials uploaded yet.";
          return;
        }

        materialsList.innerHTML = "";
        materialsMessage.textContent = "";

        snap.forEach((docSnap) => {
          const data = docSnap.data();
          const li = document.createElement("li");
          li.className = "materials-item";

          const nameSpan = document.createElement("span");
          nameSpan.textContent = data.fileName || "Untitled PDF";

          const actionsDiv = document.createElement("div");
          actionsDiv.className = "materials-actions";

          const viewLink = document.createElement("a");
          viewLink.href = data.downloadURL;
          viewLink.target = "_blank";
          viewLink.rel = "noopener";
          viewLink.textContent = "View / Download";
          viewLink.className = "btn";
          viewLink.style.padding = "6px 10px";
          viewLink.style.fontSize = ".85rem";

          actionsDiv.appendChild(viewLink);

          // Only teachers can see delete button
          if (isTeacher) {
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.className = "btn secondary";
            deleteBtn.style.padding = "6px 10px";
            deleteBtn.style.fontSize = ".85rem";

            deleteBtn.addEventListener("click", async () => {
              const confirmed = window.confirm("Are you sure you want to delete this file?");
              if (!confirmed) return;

              materialsMessage.style.color = "#6b7280";
              materialsMessage.textContent = "Deletingâ€¦";

              try {
                if (data.storagePath) {
                  const storageRef = ref(storage, data.storagePath);
                  await deleteObject(storageRef);
                }
                await deleteDoc(doc(db, "materials", docSnap.id));

                li.remove();
                materialsMessage.style.color = "#16a34a";
                materialsMessage.textContent = "File deleted.";
              } catch (err) {
                console.error("Delete error:", err);
                materialsMessage.style.color = "#b91c1c";
                materialsMessage.textContent = err.message || "Failed to delete file.";
              }
            });

            actionsDiv.appendChild(deleteBtn);
          }

          li.appendChild(nameSpan);
          li.appendChild(actionsDiv);
          materialsList.appendChild(li);
        });
      } catch (err) {
        console.error("Error loading materials:", err);
        materialsMessage.style.color = "#b91c1c";
        materialsMessage.textContent = err.message || "Failed to load materials.";
      }
    }

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (!user) {
        materialsMessage.style.color = "#b91c1c";
        materialsMessage.textContent = "You must be logged in to view study materials.";
        // Optional redirect:
        // window.location.href = "../login/login.html";
        return;
      }

      materialsMessage.style.color = "#6b7280";
      materialsMessage.textContent = "Loading your permissionsâ€¦";

      await loadUserRole(user);

      materialsMessage.textContent = "Loading materialsâ€¦";
      await loadMaterials();
    });
  </script>
</body>
</html>
